name: Update Cookie

on:
  workflow_dispatch:  # 手動で実行（あとでスケジュールも可能）
  schedule:
    - cron: "0 */3 * * *"  # 3時間ごとに実行したい場合

jobs:
  update-cookie:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install gspread google-auth selenium webdriver-manager

      - name: Update cookie and write to Google Sheets
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          python - <<'EOF'
          import os
          import json
          import time
          import gspread
          from google.oauth2.service_account import Credentials
          from selenium import webdriver
          from selenium.webdriver.chrome.service import Service
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from webdriver_manager.chrome import ChromeDriverManager

          # ===============================
          # 設定
          # ===============================
          BBS_URL = "https://bbs1.sekkaku.net/bbs/canada2025/"
          USERNAME = "カナダ"
          PASSWORD = "a"
          SPREADSHEET_NAME = "カナダ監視設定"
          WORKSHEET_NAME = "config"
          CELL_LOCATION = "B2"

          # ===============================
          # Google Sheets 認証
          # ===============================
          creds_json = os.environ.get("GOOGLE_CREDENTIALS")
          if not creds_json:
              raise RuntimeError("GOOGLE_CREDENTIALS 環境変数が設定されていません")
          creds_dict = json.loads(creds_json)
          creds = Credentials.from_service_account_info(
              creds_dict,
              scopes=[
                  "https://www.googleapis.com/auth/spreadsheets",
                  "https://www.googleapis.com/auth/drive"
              ]
          )
          gc = gspread.authorize(creds)
          ws = gc.open(SPREADSHEET_NAME).worksheet(WORKSHEET_NAME)
          print(f"✅ Connected to Google Sheets: {ws.title}")

          # ===============================
          # Chrome 設定
          # ===============================
          chrome_options = Options()
          chrome_options.add_argument("--headless=new")
          chrome_options.add_argument("--no-sandbox")
          chrome_options.add_argument("--disable-dev-shm-usage")

          service = Service(ChromeDriverManager().install())
          driver = webdriver.Chrome(service=service, options=chrome_options)

          try:
              # ===============================
              # ログイン
              # ===============================
              driver.get(BBS_URL)
              time.sleep(2)
              driver.find_element(By.NAME, "member_name").send_keys(USERNAME)
              driver.find_element(By.NAME, "member_password").send_keys(PASSWORD)
              driver.find_element(By.XPATH, "//input[@type='submit' and @value='ログイン']").click()
              time.sleep(3)
              print("✅ Login completed")

              # ===============================
              # クッキー取得
              # ===============================
              cookies = driver.get_cookies()
              cookie_str = "; ".join([f"{c['name']}={c['value']}" for c in cookies])
              print(f"🍪 Cookie: {cookie_str}")

              # ===============================
              # Google Sheets に書き込み
              # ===============================
              ws.update(CELL_LOCATION, cookie_str)
              print(f"✅ Cookie written to {SPREADSHEET_NAME}! ({WORKSHEET_NAME}!{CELL_LOCATION})")

          finally:
              driver.quit()
              print("🧹 Chrome closed")
          EOF
