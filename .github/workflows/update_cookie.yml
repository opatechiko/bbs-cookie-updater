name: Update BBS Cookie

on:
  workflow_dispatch:   # 手動トリガー
  schedule:
    - cron: '0 */6 * * *'  # 6時間ごとに実行（調整可能）

jobs:
  update-cookie:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium gspread google-auth google-auth-oauthlib google-auth-httplib2 webdriver-manager

      - name: Run update_cookie.py
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          python - <<'EOF'
import time
import json
import os
import gspread
from google.oauth2.service_account import Credentials
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from webdriver_manager.chrome import ChromeDriverManager

# ===============================
# 設定
# ===============================
BBS_URL = "https://bbs1.sekkaku.net/bbs/canada2025/"
USERNAME = "カナダ"
PASSWORD = "a"

SPREADSHEET_NAME = "カナダ監視設定"
WORKSHEET_NAME = "config"
CELL_LOCATION = "B2"

# ===============================
# Google Sheets 認証
# ===============================
print("🔑 Authenticating with Google Sheets...")
credentials_json = os.environ.get("GOOGLE_CREDENTIALS")
if not credentials_json:
    raise RuntimeError("❌ GOOGLE_CREDENTIALS 環境変数が設定されていません。")

creds_dict = json.loads(credentials_json)
creds = Credentials.from_service_account_info(
    creds_dict,
    scopes=[
        "https://www.googleapis.com/auth/spreadsheets",
        "https://www.googleapis.com/auth/drive"
    ]
)
gc = gspread.authorize(creds)
ws = gc.open(SPREADSHEET_NAME).worksheet(WORKSHEET_NAME)
print(f"✅ Connected to Google Sheets: {WORKSHEET_NAME}")

# ===============================
# Chromeドライバ設定
# ===============================
print("🚀 Launching headless Chrome...")
chrome_options = Options()
chrome_options.add_argument("--headless=new")
chrome_options.add_argument("--no-sandbox")
chrome_options.add_argument("--disable-dev-shm-usage")
service = Service(ChromeDriverManager().install())
driver = webdriver.Chrome(service=service, options=chrome_options)

try:
    # ===============================
    # ログイン処理
    # ===============================
    print(f"🌐 Accessing {BBS_URL}")
    driver.get(BBS_URL)
    time.sleep(2)

    name_input = driver.find_element(By.NAME, "member_name")
    pw_input = driver.find_element(By.NAME, "member_password")

    name_input.clear()
    name_input.send_keys(USERNAME)
    pw_input.clear()
    pw_input.send_keys(PASSWORD)

    login_btn = driver.find_element(By.XPATH, "//input[@type='submit' and @value='ログイン']")
    login_btn.click()
    time.sleep(3)
    print("✅ Login completed.")

    # ===============================
    # クッキー取得
    # ===============================
    cookies = driver.get_cookies()
    cookie_str = "; ".join([f"{c['name']}={c['value']}" for c in cookies])
    print(f"🍪 Cookie: {cookie_str}")

    # ===============================
    # Google Sheetsへ書き込み
    # ===============================
    ws.update(CELL_LOCATION, [[cookie_str]])
    print(f"✅ Cookie written to {SPREADSHEET_NAME}! ({WORKSHEET_NAME}!{CELL_LOCATION})")

except Exception as e:
    print(f"❌ Error: {e}")

finally:
    driver.quit()
    print("🧹 Chrome closed.")
EOF
