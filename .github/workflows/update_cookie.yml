name: Update Cookie

on:
  workflow_dispatch:  # æ‰‹å‹•ã§å®Ÿè¡Œï¼ˆã‚ã¨ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚å¯èƒ½ï¼‰
  schedule:
    - cron: "0 */3 * * *"  # 3æ™‚é–“ã”ã¨ã«å®Ÿè¡Œã—ãŸã„å ´åˆ

jobs:
  update-cookie:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install gspread google-auth selenium webdriver-manager

      - name: Update cookie and write to Google Sheets
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          python - <<'EOF'
          import os
          import json
          import time
          import gspread
          from google.oauth2.service_account import Credentials
          from selenium import webdriver
          from selenium.webdriver.chrome.service import Service
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from webdriver_manager.chrome import ChromeDriverManager

          # ===============================
          # è¨­å®š
          # ===============================
          BBS_URL = "https://bbs1.sekkaku.net/bbs/canada2025/"
          USERNAME = "ã‚«ãƒŠãƒ€"
          PASSWORD = "a"
          SPREADSHEET_NAME = "ã‚«ãƒŠãƒ€ç›£è¦–è¨­å®š"
          WORKSHEET_NAME = "config"
          CELL_LOCATION = "B2"

          # ===============================
          # Google Sheets èªè¨¼
          # ===============================
          creds_json = os.environ.get("GOOGLE_CREDENTIALS")
          if not creds_json:
              raise RuntimeError("GOOGLE_CREDENTIALS ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
          creds_dict = json.loads(creds_json)
          creds = Credentials.from_service_account_info(
              creds_dict,
              scopes=[
                  "https://www.googleapis.com/auth/spreadsheets",
                  "https://www.googleapis.com/auth/drive"
              ]
          )
          gc = gspread.authorize(creds)
          ws = gc.open(SPREADSHEET_NAME).worksheet(WORKSHEET_NAME)
          print(f"âœ… Connected to Google Sheets: {ws.title}")

          # ===============================
          # Chrome è¨­å®š
          # ===============================
          chrome_options = Options()
          chrome_options.add_argument("--headless=new")
          chrome_options.add_argument("--no-sandbox")
          chrome_options.add_argument("--disable-dev-shm-usage")

          service = Service(ChromeDriverManager().install())
          driver = webdriver.Chrome(service=service, options=chrome_options)

          try:
              # ===============================
              # ãƒ­ã‚°ã‚¤ãƒ³
              # ===============================
              driver.get(BBS_URL)
              time.sleep(2)
              driver.find_element(By.NAME, "member_name").send_keys(USERNAME)
              driver.find_element(By.NAME, "member_password").send_keys(PASSWORD)
              driver.find_element(By.XPATH, "//input[@type='submit' and @value='ãƒ­ã‚°ã‚¤ãƒ³']").click()
              time.sleep(3)
              print("âœ… Login completed")

              # ===============================
              # ã‚¯ãƒƒã‚­ãƒ¼å–å¾—
              # ===============================
              cookies = driver.get_cookies()
              cookie_str = "; ".join([f"{c['name']}={c['value']}" for c in cookies])
              print(f"ğŸª Cookie: {cookie_str}")

              # ===============================
              # Google Sheets ã«æ›¸ãè¾¼ã¿
              # ===============================
              ws.update(CELL_LOCATION, cookie_str)
              print(f"âœ… Cookie written to {SPREADSHEET_NAME}! ({WORKSHEET_NAME}!{CELL_LOCATION})")

          finally:
              driver.quit()
              print("ğŸ§¹ Chrome closed")
          EOF
